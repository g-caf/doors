# Deployment Guide

This project is configured for deployment on Render.com with separate backend API and frontend services.

## Architecture

- **Backend API**: Node.js/Express server with SQLite database
- **Frontend**: React SPA served as static files
- **File Storage**: Local filesystem storage for employee photos

## Deployment Steps

### Method 1: Using render.yaml (Recommended)

1. **Connect Repository**: Link your GitHub repository to Render
2. **Deploy from Repository**: Render will automatically detect the `render.yaml` file and create both services
3. **Configure Environment Variables**: Add additional environment variables as needed in the Render dashboard

### Method 2: Manual Service Creation

#### Backend API Service

1. Create a new Web Service on Render
2. Connect your repository
3. Configure the service:
   - **Build Command**: `npm ci && npm run build`
   - **Start Command**: `npm start`
   - **Environment**: Node.js
   - **Plan**: Starter (for persistent storage)

#### Frontend Service

1. Create a new Static Site on Render
2. Connect the same repository
3. Configure the service:
   - **Build Command**: `npm ci && npm run build`
   - **Publish Directory**: `./dist`
   - **Environment**: Static

## Environment Variables

### Backend API (.env)

**Required:**
```env
NODE_ENV=production
PORT=10000
DATABASE_URL=./data/database.sqlite
JWT_SECRET=<auto-generated-secret>
```

**Email Configuration (Choose one):**
```env
# SMTP Configuration
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
FROM_EMAIL=noreply@yourdomain.com
```

**Optional:**
```env
DEFAULT_ADMIN_PASSWORD=<auto-generated-password>
MAX_FILE_SIZE=5242880
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100
FRONTEND_URL=https://your-frontend-url.onrender.com
```

### Frontend (.env)

```env
VITE_API_URL=https://your-api-service.onrender.com
VITE_APP_TITLE=Guest Check-in System
VITE_COMPANY_NAME=Your Company Name
```

## Database Initialization

The database will be automatically initialized on first startup. The initialization script will:

1. Create all required tables
2. Create a default admin user (username: `admin`)
3. Add default system settings
4. Add sample employees (development only)

**Default Admin Credentials:**
- Username: `admin`
- Password: Check the deployment logs or use the generated `DEFAULT_ADMIN_PASSWORD`

⚠️ **Important**: Change the default admin password after first login!

## File Storage

Employee photos are stored in the local filesystem at `/uploads`. On Render's starter plan and above, files will persist across deployments.

**File Upload Limits:**
- Max file size: 5MB (configurable)
- Supported formats: JPEG, JPG, PNG, GIF

## Health Checks

The backend includes health check endpoints:
- **Public**: `GET /health`
- **Admin**: `GET /api/admin/health` (requires authentication)

Render will automatically monitor the `/health` endpoint.

## Post-Deployment Setup

### 1. Admin Setup
1. Navigate to your frontend URL
2. Create an admin account or use the default credentials
3. Change the default admin password
4. Configure system settings

### 2. Email Configuration
1. Set up SMTP credentials in environment variables
2. Test email notifications through the admin panel
3. Configure your email service (Gmail, SendGrid, etc.)

### 3. Employee Management
1. Add employees through the API or frontend
2. Upload employee photos
3. Configure notification preferences

## API Documentation

The API is automatically documented and available at:
- **API Info**: `GET /api`
- **Full Documentation**: See `API_DOCUMENTATION.md`

## Monitoring and Logs

### Health Monitoring
- **Backend Health**: `GET /health`
- **System Health**: `GET /api/admin/health` (authenticated)

### Logging
- All API requests are logged
- Database operations are logged
- Email sending attempts are logged
- Error details are logged (development mode)

### Activity Tracking
- All visitor notifications are logged in the database
- Access logs through `GET /api/notifications/logs`
- View statistics at `GET /api/notifications/stats`

## Security Considerations

### Production Checklist
- [ ] Change default admin password
- [ ] Use strong JWT secret (auto-generated recommended)
- [ ] Configure proper CORS origins
- [ ] Set up proper email authentication
- [ ] Configure rate limiting appropriately
- [ ] Enable HTTPS (automatic on Render)
- [ ] Regular database backups (manual on Render Free/Starter)

### Headers and Security
- Helmet.js for security headers
- CORS configured for specific origins
- Rate limiting on notification endpoint
- JWT token expiration (24 hours)
- Input validation on all endpoints

## Troubleshooting

### Common Issues

**Database Connection Errors:**
- Ensure `DATABASE_URL` points to a writable location
- Check disk space on Render service

**Email Not Sending:**
- Verify SMTP credentials
- Check spam folder
- Test connection via `/api/notifications/status`

**File Upload Issues:**
- Check `MAX_FILE_SIZE` setting
- Ensure uploads directory is writable
- Verify file format is supported

**Authentication Problems:**
- Verify JWT_SECRET is set
- Check token expiration
- Ensure admin user exists

### Logs Access
View logs in the Render dashboard under your service's "Logs" tab.

### Database Access
For debugging, you can connect to the SQLite database through the Render shell:
```bash
sqlite3 ./data/database.sqlite
```

## Scaling Considerations

### Current Limitations
- SQLite database (single instance)
- Local file storage
- In-memory rate limiting

### Upgrade Path
- Migrate to PostgreSQL for multi-instance deployments
- Use cloud storage (AWS S3, Cloudinary) for files
- Implement Redis for distributed rate limiting
- Add background job processing

## Support

For deployment issues:
1. Check the Render service logs
2. Verify environment variables
3. Test health endpoints
4. Review API documentation
5. Check database initialization logs

## Cost Estimation

**Render Pricing (as of deployment):**
- Backend API: Starter plan (~$7/month) for persistent storage
- Frontend: Free static hosting
- **Total**: ~$7/month

**Features included:**
- Automatic deployments
- SSL certificates
- Custom domains
- Basic monitoring
- 750 build hours/month
